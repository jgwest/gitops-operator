apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
- script: |
    function check_secret() {
      secret_type="$(oc get secrets argocd-operator-redis-tls -n $NAMESPACE --template '{{.type}}')"
      secret_len="$(oc get secrets argocd-operator-redis-tls -n $NAMESPACE --template '{{len .data}}')"
      expected_secret_type="kubernetes.io/tls"
      expected_secret_len=2

      if test ${secret_type} != ${expected_secret_type}; then
        echo "argocd-operator-redis-tls secret type is ${secret_type} and should be ${expected_secret_type}"
        return 1
      fi
      if test ${secret_len} != ${expected_secret_len}; then
        echo "argocd-operator-redis-tls secret length is ${secret_len} and should be ${expected_secret_len}"
        return 1
      fi

      return 0    
    }

    echo -n "Waiting until secret has expected type and .data length"
    for i in {1..150}; do # timeout after 5 minutes

      if check_secret; then
        # success
        echo "Secret has expected length and type."
        exit 0
      else
        echo "Still waiting for Secret to have expected length and type."
      fi
      sleep 2
    done

    echo "Secret never had expected length and type"
    exit 1
    